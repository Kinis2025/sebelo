<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sebelo Measurements</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    h1 {
      text-align: center;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      padding: 6px;
      border: 1px solid black;
      text-align: center;
    }
    .green {
      background-color: #ccffcc;
      font-weight: bold;
    }
    .yellow {
      background-color: #ffffcc;
      font-weight: bold;
    }
    .orange {
      background-color: #ffcc99;
      font-weight: bold;
    }
    .red {
      background-color: #ffcccc;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Sebelo Measurements</h1>
  <table>
    <thead>
      <tr>
        <th>Sensor ID</th>
        <th>Date</th>
        <th>Time</th>
        <th>Normal (%)</th>
        <th>Smoke (%)</th>
        <th>Temperature (°C)</th>
        <th>Humidity (%)</th>
        <th>Pressure (hPa)</th>
        <th>Battery Level (mV)</th>
        <th>Button</th>
      </tr>
    </thead>
    <tbody id="sensorTable"></tbody>
  </table>

  <script>
    async function loadSensors() {
      const res = await fetch('/api/sensors');
      const sensors = await res.json();
      const tbody = document.getElementById('sensorTable');
      tbody.innerHTML = '';

      Object.entries(sensors).forEach(([id, data]) => {
        const row = document.createElement('tr');

        let gas1 = data.gas1 ?? data.gas1Prob ?? '-';
        let gas2 = data.gas2 ?? data.gas2Prob ?? '-';
        let battery = data.superCapVoltage ?? '-';

        // Format time and date
        let time = data.time ? new Date(data.time) : null;
        let timeStr = time ? time.toLocaleTimeString('en-GB') : '-';
        let dateStr = time ? time.toLocaleDateString('en-GB') : '-';

        // Gas1 (Normal) coloring
        let gas1Class = (+gas1 === 100) ? 'green' : '';

        // Gas2 (Smoke) coloring - FIXED
        gas2 = parseInt(gas2);
        let gas2Class = '';
        if (gas2 === 0) gas2Class = 'green';
        else if (gas2 <= 10) gas2Class = 'yellow';
        else if (gas2 <= 50) gas2Class = 'orange';
        else gas2Class = 'red';

        // Battery coloring
        let batteryClass = '';
        battery = parseInt(battery);
        if (battery > 2000) batteryClass = 'green';
        else if (battery >= 1000) batteryClass = 'yellow';
        else if (battery > 0) batteryClass = 'red';

        row.innerHTML =
          '<td>' + id + '</td>' +
          '<td>' + dateStr + '</td>' +
          '<td>' + timeStr + '</td>' +
          '<td class="' + gas1Class + '">' + (isNaN(gas1) ? '-' : gas1 + '%') + '</td>' +
          '<td class="' + gas2Class + '">' + (isNaN(gas2) ? '-' : gas2 + '%') + '</td>' +
          '<td>' + (data.temperature ?? '-') + '</td>' +
          '<td>' + (data.humidity ?? '-') + '</td>' +
          '<td>' + (data.pressure ?? '-') + '</td>' +
          '<td class="' + batteryClass + '">' + (isNaN(battery) ? '-' : battery) + '</td>' +
          '<td>' + ((data.buttonLevel ?? 0) === 1 ? '✔️' : '—') + '</td>';

        tbody.appendChild(row);
      });
    }

    setInterval(loadSensors, 5000);
    loadSensors();
  </script>
</body>
</html>
