<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sebelo Measurements</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
    }

    h1 {
      text-align: center;
      margin: 12px 0;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
    }

    .table-container {
      flex: 1 1 55%;
      min-width: 320px;
    }

    .map-container {
      flex: 1 1 40%;
      min-width: 320px;
      height: 600px;
      position: relative;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      padding: 6px;
      border: 1px solid black;
      text-align: center;
    }

    .green { background-color: #ccffcc; font-weight: bold; }
    .yellow { background-color: #ffffcc; font-weight: bold; }
    .orange { background-color: #ffcc99; font-weight: bold; }
    .red { background-color: #ffcccc; font-weight: bold; }

    #map {
      height: 100%;
      width: 100%;
    }

    .wind-box {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      border: 1px solid #aaa;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
      z-index: 999;
    }

    .wind-arrow {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-bottom: 4px;
      background: black;
      clip-path: polygon(50% 0%, 100% 100%, 50% 80%, 0% 100%);
      transform-origin: center;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .map-container {
        height: 400px;
      }
    }

    .popup-id {
      color: blue;
      text-decoration: underline;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Sebelo Measurements</h1>

  <div class="container">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Sensor ID</th>
            <th>Date</th>
            <th>Time</th>
            <th>Normal (%)</th>
            <th>Smoke (%)</th>
            <th>Temp (Â°C)</th>
            <th>Humidity (%)</th>
            <th>Pressure (hPa)</th>
            <th>Battery</th>
            <th>Button</th>
            <th>Change coordinates</th>
          </tr>
        </thead>
        <tbody id="sensorTable"></tbody>
      </table>
    </div>

    <div class="map-container">
      <div id="map"></div>
      <div class="wind-box" id="windInfo">
        <div id="windArrow" class="wind-arrow"></div>
        <div id="windText">--</div>
      </div>
    </div>
  </div>

  <script>
    const OWM_KEY = "a50b25ff35ae650ef4db95bb3db5f4f1";
    const windTextEl = document.getElementById("windText");
    const windArrowEl = document.getElementById("windArrow");

    const windDirectionText = deg => {
      const dirs = ["Z", "ZZA", "ZA", "AZA", "A", "ADA", "DA", "DZA"];
      return dirs[Math.round(deg / 45) % 8];
    };

    const getSmokeColor = val => {
      if (val >= 50) return "red";
      if (val >= 20) return "orange";
      if (val >= 1) return "yellow";
      return "green";
    };

    const createColoredIcon = color => L.divIcon({
      className: "",
      html: `<div style="width:16px;height:16px;background:${color};border-radius:50%;border:2px solid black;"></div>`,
      iconSize: [16, 16]
    });

    let map = L.map('map').setView([56.95, 24.1], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    async function loadData() {
      const [sensorRes, locRes] = await Promise.all([
        fetch('/api/sensors'),
        fetch('/api/map-sensors')
      ]);

      const sensors = await sensorRes.json();
      const locations = await locRes.json();
      const tbody = document.getElementById('sensorTable');
      tbody.innerHTML = '';

      for (const sensorId in sensors) {
        const data = sensors[sensorId];
        const loc = locations.find(l => l.sensor_id === sensorId);
        if (!loc || !loc.latitude || !loc.longitude) continue;

        const d = new Date(data.time);
        const dateStr = d.toLocaleDateString('lv-LV');
        const timeStr = d.toLocaleTimeString('lv-LV');

        // Tabula
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a href="/sensor/${sensorId}" target="_blank">${sensorId}</a></td>
          <td>${dateStr}</td>
          <td>${timeStr}</td>
          <td class="${data.gas1 == 100 ? 'green' : ''}">${data.gas1 ?? '-'}</td>
          <td class="${getSmokeColor(data.gas2)}">${data.gas2 ?? '-'}</td>
          <td>${data.temperature ?? '-'}</td>
          <td>${data.humidity ?? '-'}</td>
          <td>${data.pressure ?? '-'}</td>
          <td class="${data.supercap_voltage > 2000 ? 'green' : data.supercap_voltage > 1000 ? 'yellow' : 'red'}">${data.supercap_voltage ?? '-'}</td>
          <td>${data.button_level ?? '-'}</td>
          <td><button onclick="window.location.href='/admin'">Change</button></td>
        `;
        tbody.appendChild(tr);

        // VÄ“jÅ¡
        const weather = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${loc.latitude}&lon=${loc.longitude}&appid=${OWM_KEY}&units=metric`).then(r => r.json());
        const windSpeed = weather.wind?.speed ?? 0;
        const windDeg = weather.wind?.deg ?? 0;
        const windTxt = windDirectionText(windDeg);

        windArrowEl.style.transform = `rotate(${windDeg}deg)`;
        windTextEl.textContent = `ðŸ’¨ ${windSpeed} m/s ${windTxt}`;

        // MarÄ·ieris
        const color = getSmokeColor(data.gas2);
        const icon = createColoredIcon(color);

        const popup = `
          <div>
            <span class="popup-id" onclick="window.location='/sensor/${sensorId}'">${sensorId}</span><br>
            Smoke: ${data.gas2}%<br>
            Temp: ${data.temperature}Â°C<br>
            Humidity: ${data.humidity}%<br>
            Pressure: ${data.pressure}<br>
            Time: ${dateStr} ${timeStr}
          </div>
        `;

        L.marker([loc.latitude, loc.longitude], { icon }).addTo(map).bindPopup(popup);
      }
    }

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
