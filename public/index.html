<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sebelo Measurements</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-wrap: wrap;
    }

    h1 {
      width: 100%;
      text-align: center;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }

    th, td {
      padding: 6px;
      border: 1px solid black;
      text-align: center;
    }

    .green { background-color: #ccffcc; font-weight: bold; }
    .yellow { background-color: #ffffcc; font-weight: bold; }
    .orange { background-color: #ffcc99; font-weight: bold; }
    .red { background-color: #ffcccc; font-weight: bold; }

    #map {
      height: 500px;
      width: 100%;
      margin-top: 20px;
      border: 1px solid #aaa;
    }

    .wind-arrow {
      width: 20px;
      height: 20px;
      display: inline-block;
      background: black;
      clip-path: polygon(50% 0%, 100% 100%, 50% 80%, 0% 100%);
      transform-origin: center;
    }

    @media (min-width: 768px) {
      #map { height: 600px; }
    }
  </style>
</head>
<body>
  <h1>Sebelo Measurements</h1>

  <table>
    <thead>
      <tr>
        <th>Sensor ID</th>
        <th>Date</th>
        <th>Time</th>
        <th>Normal (%)</th>
        <th>Smoke (%)</th>
        <th>Temp (Â°C)</th>
        <th>Humidity (%)</th>
        <th>Pressure (hPa)</th>
        <th>Battery</th>
        <th>Button</th>
        <th>Change coordinates</th>
      </tr>
    </thead>
    <tbody id="sensorTable"></tbody>
  </table>

  <div id="map"></div>

  <script>
    const OWM_KEY = "a50b25ff35ae650ef4db95bb3db5f4f1";
    const windDirectionText = deg => {
      const dirs = ["Z", "ZZA", "ZA", "AZA", "A", "ADA", "DA", "DZA"];
      return dirs[Math.round(deg / 45) % 8];
    };

    let map = L.map('map').setView([56.95, 24.1], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    async function loadData() {
      const [dataRes, coordRes] = await Promise.all([
        fetch('/api/sensors'),
        fetch('/api/map-sensors')
      ]);

      const sensors = await dataRes.json();
      const locations = await coordRes.json();
      const tbody = document.getElementById('sensorTable');
      tbody.innerHTML = '';

      for (const sensorId in sensors) {
        const row = sensors[sensorId];
        const loc = locations.find(l => l.sensor_id === sensorId);
        if (!loc || !loc.latitude || !loc.longitude) continue;

        const d = new Date(row.time);
        const dateStr = d.toLocaleDateString('lv-LV');
        const timeStr = d.toLocaleTimeString('lv-LV');

        // Tabula
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a href="/sensor/${sensorId}" target="_blank">${sensorId}</a></td>
          <td>${dateStr}</td>
          <td>${timeStr}</td>
          <td class="${row.gas1 == 100 ? 'green' : ''}">${row.gas1 ?? '-'}</td>
          <td class="${row.gas2 >= 50 ? 'red' : row.gas2 >= 20 ? 'orange' : row.gas2 >= 1 ? 'yellow' : 'green'}">${row.gas2 ?? '-'}</td>
          <td>${row.temperature ?? '-'}</td>
          <td>${row.humidity ?? '-'}</td>
          <td>${row.pressure ?? '-'}</td>
          <td class="${row.supercap_voltage > 2000 ? 'green' : row.supercap_voltage > 1000 ? 'yellow' : 'red'}">${row.supercap_voltage ?? '-'}</td>
          <td>${row.button_level ?? '-'}</td>
          <td><button onclick="window.location.href='/admin'">Change</button></td>
        `;
        tbody.appendChild(tr);

        // VÄ“jÅ¡
        const weatherRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${loc.latitude}&lon=${loc.longitude}&appid=${OWM_KEY}&units=metric`);
        const weather = await weatherRes.json();
        const windSpeed = weather.wind?.speed ?? 0;
        const windDeg = weather.wind?.deg ?? 0;
        const windTxt = windDirectionText(windDeg);

        const popup = `
          <b>${sensorId}</b><br>
          Smoke: ${row.gas2 ?? '-'}%<br>
          Temp: ${row.temperature ?? '-'}Â°C<br>
          Humidity: ${row.humidity ?? '-'}%<br>
          Pressure: ${row.pressure ?? '-'}<br>
          Time: ${dateStr} ${timeStr}<br>
          ðŸ’¨ VÄ“jÅ¡: ${windSpeed} m/s ${windTxt}
        `;

        const marker = L.marker([loc.latitude, loc.longitude]).addTo(map).bindPopup(popup);

        // VÄ“ja bulta
        const windIcon = L.divIcon({
          html: `<div class="wind-arrow" style="transform: rotate(${windDeg}deg);"></div>`,
          iconSize: [20, 20],
          className: ''
        });
        L.marker([loc.latitude, loc.longitude], { icon: windIcon }).addTo(map);
      }
    }

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
